name: Chatraj Agent

permissions:
  contents: read

on:
    workflow_dispatch: {}
    schedule:
        - cron: "0 3 * * *"

jobs:
    run-agent:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install -r .github/agents/chatraj_agent/requirements.txt || true

            - name: Run python unit tests
              run: |
                  python -m pytest .github/agents/chatraj_agent/tests -q

                  - name: Run agent scan
                    run: |
                        python -m .github.agents.chatraj_agent.agent scan

                  - name: Trigger automated PR flow (optional)
                    env:
                      AUTO_PR_ENABLE: ${{ secrets.AUTO_PR_ENABLE }}
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    run: |
                      # AUTO_PR_ENABLE must be set to 'true' in repository secrets to enable
                      python -m .github.agents.chatraj_agent.auto_pr || true

            - name: Generate frontend sitemap (if present)
              run: |
                  if [ -d frontend ]; then cd frontend && npm ci && npm run generate-sitemap || true; fi
